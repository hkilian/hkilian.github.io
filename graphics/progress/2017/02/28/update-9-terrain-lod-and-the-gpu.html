<!DOCTYPE html><html lang="">
  <head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>Update 9: Terrain LOD and the GPU - Harry Kilian</title>
<meta name="description" content="Previously the mesh for the terrain was generated on the CPU, both positions and normals. While this ‘worked’, it was extremely slow. So slow in fact, that i...">
<link rel="canonical" href="/graphics/progress/2017/02/28/update-9-terrain-lod-and-the-gpu.html"><link rel="alternate" type="application/rss+xml" title="Harry Kilian" href="/feed.xml">
<!-- for Safari on iOS https://developer.apple.com/ios/human-interface-guidelines/icons-and-images/app-icon/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/images/logo/icon-180x180.png"><link rel="apple-touch-icon" sizes="167x167" href="/assets/images/logo/icon-167x167.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/images/logo/icon-152x152.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/images/logo/icon-120x120.png"><link rel="shortcut icon" href="/assets/images/logo/icon-120x120.png">
<!-- for Chrome on Android https://developer.chrome.com/multidevice/android/installtohomescreen -->
<meta name="mobile-web-app-capable" content="yes"><link rel="icon" sizes="192x192" href="/assets/images/logo/icon-192x192.png">
<!-- for Edge on Windows 10 https://msdn.microsoft.com/en-us/library/dn255024(v=vs.85).aspx --><meta name="msapplication-TileImage" content="/assets/images/logo/icon-144x144.png"><meta name="msapplication-square310x310logo" content="/assets/images/logo/icon-310x310.png"><meta name="msapplication-wide310x150logo" content="/assets/images/logo/icon-310x150.png"><meta name="msapplication-square150x150logo" content="/assets/images/logo/icon-150x150.png"><meta name="msapplication-square70x70logo" content="/assets/images/logo/icon-70x70.png">
<meta name="msapplication-TileColor" content="#eeeeee"><link rel="stylesheet" href="/assets/css/blog.css">
    <style></style>
    <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
  </head>
  <body>
    <div class="m-page-stage js-page-stage"><div class="m-page-content"><header class="m-page-header main clearfix"><a class="site-title" title="Personal blog to post experiments." href="/">Harry Kilian</a><nav>
    <ul class="inline-list"><li><a href="/"></a></li><li><a href="/all.html"></a></li><li><a href="/about.html">About</a></li><li><a type="application/rss+xml" href="/feed.xml"></a></li>
    </ul>
  </nav>
</header>
<div class="m-page-main"><div class="m-post">
	<div class="main js-main">
		<div class="col-1">
			<article itemscope itemtype="http://schema.org/BlogPosting">
				<meta itemprop="mainEntityOfPage" itemscope itemType="https://schema.org/WebPage"/>
				<header class="article-header"><h1 itemprop="headline" itemprop="name headline">Update 9: Terrain LOD and the GPU</h1><div class="m-article-data clearfix"><meta itemprop="author" itemscope itemtype="https://schema.org/Person"></meta><div class="other-wrapper"><div class="date-wrapper"><time class="article-meta" datetime="2017-02-28T20:12:21+00:00"
          itemprop="datePublished">2017-02-28 20:12:21 +0000
        </time></div>
  </div>
</div>
</header>
				<div class="m-article-content js-article-content" itemprop="articleBody"><p>Previously the mesh for the terrain was generated on the CPU, both positions and normals. While this ‘worked’, it was extremely slow. So slow in fact, that it required the process to be split across multiple frames, usually it would take upward of 50 frames for one chunk to be ready on screen. Usually there are 9 chunks needed, so if the player pans quickly across the map then it takes a long time for the terrain to prepare. Now this would be fine for a small map size, as I could just cache the terrain mesh for each chunk. But for a large map (4096 x 4095), it would take up to much memory. Also another issue was that with CPU bound mesh generation it’s difficult to alter the mesh in real time.</p>

<p>The new method involves moving the mesh calculation to the GPU and having just one small flat mesh which follows the camera. The vertex shader then reads in values from a texture and calculates the correct Y position. The downside is that I can’t do greedy meshing or any kind of optimisation to reduce the verts. However the upside is that mesh generation is instant and the terrain can be updated in realtime.</p>

<p>Another big issue was terrain LOD, which was proving very difficult. The issue is that it’s very hard to simplify a voxel style mesh, a cube is still a cube at any distance and can not be reduced further. You can see some experiments with smooth meshing at low LOD in previous posts, I was not very happy with the results. My new solution is to show the map in strictly 2 dimensions when zoomed out. So what the player sees is actually just one quad. The interesting part is that directional light and depth still work as normal. The quad writes directly into the depth buffer the Y value at the given tile. So when the ocean is rendered in the next pass, it can discard fragments above sea level by looking at the depth. I’ve also done done some work with an adaptive LOD for grass, so the number of rendered shells decreases as you zoom out.</p>

<p><img src="/assets/screenshot_sun_feb_26_19_50_26_2017.png" alt="screenshot" /></p>

<p><img src="/assets/screenshot_sun_feb_26_19_50_32_2017.png" alt="screenshot" /></p>

<p><img src="/assets/screenshot_sun_feb_26_19_50_37_2017.png" alt="screenshot" /></p>

<p><img src="/assets/screenshot_sun_feb_26_19_50_42_2017.png" alt="screenshot" /></p>

<p><img src="/assets/screenshot_sun_feb_26_19_50_46_2017.png" alt="screenshot" /></p>

<p><img src="/assets/screenshot_sun_feb_26_19_50_52_2017.png" alt="screenshot" /></p>

</div>
				<footer><meta itemprop="dateModified" content="2017-02-28T20:12:21+00:00"></footer><section></section>
					<section></section></article>
		</div>
		<div class="col-2">
			<aside class="js-article-aside"><div class="m-toc js-toc"></div></aside>
		</div>
	</div>
</div>

<script src="//cdn.bootcss.com/toc/0.3.2/toc.min.js"></script>
<script type="text/javascript">
	window.throttle = function(func, wait) {
	  var args, result, thisArg, timeoutId, lastCalled = 0;

	  function trailingCall() {
	    lastCalled = new Date;
	    timeoutId = null;
	    result = func.apply(thisArg, args);
	  }
	  return function() {
	    var now = new Date,
	      remaining = wait - (now - lastCalled);

	    args = arguments;
	    thisArg = this;

	    if (remaining <= 0) {
	      clearTimeout(timeoutId);
	      timeoutId = null;
	      lastCalled = now;
	      result = func.apply(thisArg, args);
	    } else if (!timeoutId) {
	      timeoutId = setTimeout(trailingCall, remaining);
	    }
	    return result;
	  };
	}
	$(function() {
	  var $window = $(window);
	  var $pageStage = $('.js-page-stage');
	  var $pageMain = $('.js-main');
	  var $pageFooter = $('.js-page-footer');
	  var $articleContent = $('.js-article-content');
	  var $articleAside = $('.js-article-aside');
	  var $toc = $('.js-toc');
	  var hasTitle = $articleContent.find('h1, h2, h3').length > 0;

	  function asideSticky() {
	    return $window.outerWidth() > 1150 && $pageStage.hasClass('has-toc');
	  }

	  function setTocClass() {
	    if (hasTitle) {
	      !$pageStage.hasClass('has-toc') && $pageStage.addClass('has-toc');
	    }
	  }

	  setTocClass();

	  function setAsideTOC() {
	    var asideTop, asideLeft, scrollBottom, asideBottomTop, lastScrollTop;

	    function init() {
	      var asideOffset = $articleAside.offset();
	      var footerOffset = $pageFooter.offset();
	      var mainOffset = $pageMain.offset();
	      asideTop = mainOffset.top;
	      asideHeight = $toc.outerHeight() + parseInt($articleAside.css('padding-top'), 10) + parseInt($articleAside.css('padding-bottom'), 10);
	      asideLeft = mainOffset.left + $pageMain.outerWidth() - $articleAside.outerWidth() - parseInt($pageMain.css('padding-right'), 10);
	      scrollBottom = footerOffset.top - asideHeight;
	      asideBottomTop = scrollBottom - mainOffset.top;
	    }

	    function setAside(force) {
	      force !== true && (force = false);
	      var scrollTop = $window.scrollTop();
	      if (scrollTop >= asideTop && scrollTop <= scrollBottom) {
	        (!force && lastScrollTop >= asideTop && lastScrollTop <= scrollBottom) ||
	        $articleAside.addClass('fixed').css({
	          left: asideLeft + 'px',
	          top: 0
	        });
	      } else if (scrollTop < asideTop) {
	        (!force && lastScrollTop < asideTop) ||
	        $articleAside.removeClass('fixed').css({
	          left: 0,
	          top: 0
	        });
	      } else {
	        (!force && lastScrollTop > scrollBottom) ||
	        $articleAside.removeClass('fixed').css({
	          left: 0,
	          top: asideBottomTop + 'px'
	        });
	      }
	      lastScrollTop = scrollTop;
	    }
	    asideSticky() && (init(), setAside());
	    $window.on('scroll', function() {
	      asideSticky() && setAside();
	    });
	    $window.on('resize', throttle(function() {
	      setTocClass();
	      asideSticky() && (init(), setAside(true));
	    }, 100));
	    setTimeout(init, 4000);
	  }
	  setTimeout(setAsideTOC, 1000);

	  $toc.toc({
	    'selectors': 'h1,h2,h3',
	    'container': '.js-article-content',
	  });
	});
</script></div>
</div>
</div><div class="m-page-footer js-page-footer">
  <div class="main">
    <aside><div class="follow-me"><ul class="inline-list" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="">
    <link itemprop="url" href="/"></ul></div>
</aside>
    <footer class="site-info">
      <p>© Harry Kilian </p>
      <p>Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a succinct theme for blogging." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.</p>
    </footer>
  </div>
</div><script>
      $(function() {
        // display coding language
        $(".highlight").each(function() {
          $(this).attr("data-lang", $(this).find("code").attr("data-lang"));
        });
      });
    </script></body>
</html>
